{% extends "base.html" %}
{% block title %}Patterns — ChatGPT Statistics{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ path_prefix }}/static/patterns.css">
{% endblock %}

{% block content %}

<section class="chart-section fade-in">
  <h2>Activity Heatmap</h2>
  <figure class="chart-box">
    <h3>Messages by Day & Hour</h3>
    <div class="heatmap-wrap" id="heatmap-container"></div>
  </figure>
</section>

<section class="chart-section fade-in">
  <h2>Hourly Distribution</h2>
  <figure class="chart-box">
    <h3>Messages by Hour of Day</h3>
    <canvas id="chart-hourly" style="max-height: 300px;"></canvas>
  </figure>
</section>

<section class="chart-section fade-in">
  <h2>Weekly Rhythm</h2>
  <section class="weekday-stats" id="weekday-comparison"></section>
</section>

<section class="chart-section fade-in">
  <h2>Code Analysis</h2>
  <figure class="chart-box">
    <div id="code-stat-line" style="font-size: 13px; color: var(--text-dim); margin-bottom: 12px;"></div>
    <h3>Top Languages</h3>
    <canvas id="chart-code-languages" style="max-height: 340px;"></canvas>
  </figure>
</section>

<section class="chart-section fade-in">
  <h2>Activity Overview</h2>
  <section class="table-box" id="activity-table"></section>
</section>

<section class="chart-section gap-table-wrap fade-in">
  <h2>Gap Analysis</h2>
  <section class="table-box" id="gaps-table"></section>
</section>

<div class="heatmap-tooltip" id="heatmap-tooltip"></div>
{% endblock %}

{% block scripts %}
<script>
(function() {
  const D = DASHBOARD_DATA;
  if (!D.hourly) return;

  const DAYS = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
  const FULL_DAYS = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
  const HOUR_LABELS = [0, 3, 6, 9, 12, 15, 18, 21];

  /** @param {number} val @param {number} maxVal @returns {string} CSS colour */
  function cellColor(val, maxVal) {
    if (val === 0 || maxVal === 0) return 'var(--surface2)';
    const ratio = val / maxVal;
    if (ratio < 0.25) return cssAlpha('--amber', 0.2);
    if (ratio < 0.50) return cssAlpha('--amber', 0.5);
    if (ratio < 0.75) return cssAlpha('--amber', 0.8);
    return 'var(--amber)';
  }

  /**
   * Build the 7x24 heatmap grid with row labels and ARIA cells.
   * @param {number[][]} heatmap @param {number} maxVal @returns {HTMLElement}
   */
  function buildHeatmapGrid(heatmap, maxVal) {
    const grid = el('div', { className: 'heatmap' });
    grid.setAttribute('role', 'grid');
    grid.setAttribute('aria-label', 'Activity heatmap showing messages by day and hour');
    for (let d = 0; d < 7; d++) {
      const rowLabel = el('div', { className: 'heatmap-label', textContent: DAYS[d] });
      rowLabel.setAttribute('role', 'row');
      grid.appendChild(rowLabel);
      for (let h = 0; h < 24; h++) {
        const val = heatmap[d][h];
        const cell = el('div', { className: 'heatmap-cell' });
        cell.style.backgroundColor = cellColor(val, maxVal);
        cell.setAttribute('data-day', DAYS[d]);
        cell.setAttribute('data-hour', String(h));
        cell.setAttribute('data-count', String(val));
        cell.setAttribute('role', 'gridcell');
        const hourStr = `${h < 10 ? '0' : ''}${h}:00`;
        cell.setAttribute('aria-label', `${FULL_DAYS[d]} ${hourStr} \u2014 ${val} messages`);
        grid.appendChild(cell);
      }
    }
    return grid;
  }

  /** Attach hover tooltip listeners. @param {HTMLElement} grid @param {HTMLElement} tooltip */
  function attachHeatmapTooltip(grid, tooltip) {
    grid.addEventListener('mouseover', function(e) {
      const cell = e.target;
      if (!cell.classList.contains('heatmap-cell')) return;
      const hourNum = parseInt(cell.getAttribute('data-hour'), 10);
      const label = `${hourNum < 10 ? '0' : ''}${hourNum}:00`;
      const count = parseInt(cell.getAttribute('data-count'), 10);
      tooltip.textContent = `${cell.getAttribute('data-day')} ${label} \u2014 ${count.toLocaleString()} msgs`;
      tooltip.style.display = 'block';
    });
    grid.addEventListener('mousemove', function(e) {
      tooltip.style.left = `${e.clientX + 12}px`;
      tooltip.style.top = `${e.clientY - 30}px`;
    });
    grid.addEventListener('mouseout', function(e) {
      if (!e.target.classList.contains('heatmap-cell')) return;
      tooltip.style.display = 'none';
    });
  }

  /** Build the 7x24 activity heatmap with hour labels and tooltip. */
  function buildHeatmap() {
    const heatmap = D.hourly.heatmap;
    if (!heatmap || heatmap.length !== 7) return;
    const container = document.getElementById('heatmap-container');
    const tooltip = document.getElementById('heatmap-tooltip');
    // Find max value for intensity scaling
    let maxVal = 0;
    for (let d = 0; d < 7; d++) {
      for (let h = 0; h < 24; h++) {
        if (heatmap[d][h] > maxVal) maxVal = heatmap[d][h];
      }
    }
    // Hour labels row
    const hourRow = el('div', { className: 'heatmap-hour-labels' });
    hourRow.appendChild(el('div')); // spacer for row label column
    for (let h = 0; h < 24; h++) {
      const lbl = el('div', { className: 'heatmap-hour-label' });
      if (HOUR_LABELS.indexOf(h) >= 0) lbl.textContent = String(h);
      hourRow.appendChild(lbl);
    }
    container.appendChild(hourRow);
    const grid = buildHeatmapGrid(heatmap, maxVal);
    container.appendChild(grid);
    attachHeatmapTooltip(grid, tooltip);
  }

  /** Build weekday-vs-weekend comparison cards with per-day bars. */
  function buildWeekdayCards() {
    const weekdayTotals = D.hourly.weekday_totals;
    if (!weekdayTotals || weekdayTotals.length !== 7) return;
    const compContainer = document.getElementById('weekday-comparison');
    let weekdaySum = 0, weekendSum = 0, maxDay = 0;
    for (let i = 0; i < 7; i++) {
      if (i < 5) weekdaySum += weekdayTotals[i];
      else weekendSum += weekdayTotals[i];
      if (weekdayTotals[i] > maxDay) maxDay = weekdayTotals[i];
    }
    const totalAll = weekdaySum + weekendSum;
    const weekdayAvg = Math.round(weekdaySum / 5);
    const weekendAvg = Math.round(weekendSum / 2);
    const ratio = weekendAvg > 0 ? (weekdayAvg / weekendAvg).toFixed(2) : '\u2014';

    /** Create a stat card with big number, subtitle, and per-day bars. @returns {HTMLElement} */
    function createCard(title, sum, avg, startIdx, endIdx, colour) {
      const card = el('div', { className: 'weekday-stat-card' });
      card.appendChild(txt('h3', title));
      const big = txt('div', sum.toLocaleString(), 'weekday-stat-big');
      big.style.color = `var(--${colour})`;
      card.appendChild(big);
      card.appendChild(txt('div', `total messages \u00b7 ${avg.toLocaleString()}/day avg`, 'weekday-stat-sub'));
      card.appendChild(txt('div', `${Math.round(sum / totalAll * 100)}% of all messages`, 'weekday-stat-sub'));

      for (let i = startIdx; i < endIdx; i++) {
        const row = el('div', { className: 'weekday-bar-row' });
        row.appendChild(txt('span', DAYS[i], 'weekday-bar-label'));
        const track = el('div', { className: 'weekday-bar-track' });
        const fill = el('div', { className: 'weekday-bar-fill' });
        fill.style.width = `${maxDay > 0 ? (weekdayTotals[i] / maxDay * 100) : 0}%`;
        fill.style.background = `var(--${colour})`;
        track.appendChild(fill);
        row.appendChild(track);
        row.appendChild(txt('span', weekdayTotals[i].toLocaleString(), 'weekday-bar-value'));
        card.appendChild(row);
      }
      return card;
    }

    compContainer.appendChild(createCard('Weekdays (Mon\u2013Fri)', weekdaySum, weekdayAvg, 0, 5, 'skyblue'));

    const weCard = createCard('Weekends (Sat\u2013Sun)', weekendSum, weekendAvg, 5, 7, 'amber');
    const ratioNote = txt('div', `Weekday/weekend ratio: ${ratio}x`, 'weekday-stat-sub');
    ratioNote.style.marginTop = '12px';
    weCard.appendChild(ratioNote);
    compContainer.appendChild(weCard);
  }

  /** Build the hourly distribution horizontal bar chart. */
  function buildHourlyChart() {
    const hourlyTotals = D.hourly.hourly_totals;
    if (!hourlyTotals || hourlyTotals.length !== 24) return;
    const labels = [];
    for (let i = 0; i < 24; i++) labels.push(`${i}:00`);
    const ctx = document.getElementById('chart-hourly').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Messages',
          data: hourlyTotals,
          backgroundColor: cssAlpha('--skyblue', 0.7),
          borderWidth: 0,
          barPercentage: 0.85,
          categoryPercentage: 0.9,
        }],
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: cssVar('--surface2'),
            borderColor: cssVar('--border'),
            borderWidth: 1,
            bodyFont: { size: 12 },
            padding: 10,
            callbacks: {
              label: function(c) { return `${c.parsed.x.toLocaleString()} messages`; }
            },
          },
        },
        scales: {
          x: { beginAtZero: true, grid: { color: cssVar('--surface2') }, ticks: { precision: 0 } },
          y: { grid: { display: false }, ticks: { font: { family: "'JetBrains Mono', monospace", size: 10 } } },
        },
      },
    });
  }

  /** Build the code languages horizontal bar chart and summary line. */
  function buildCodeLanguagesChart() {
    const codeStats = D.code_stats;
    if (codeStats && codeStats.language_counts && codeStats.language_counts.length) {
      const statLine = document.getElementById('code-stat-line');
      statLine.textContent = `${codeStats.pct_with_code}% of conversations include code blocks (${codeStats.total_conversations_with_code.toLocaleString()} conversations)`;
      const top10 = codeStats.language_counts.slice(0, 10);
      const langLabels = top10.map(function(l) { return l.language; });
      const langCounts = top10.map(function(l) { return l.count; });

      const langCtx = document.getElementById('chart-code-languages').getContext('2d');
      new Chart(langCtx, {
        type: 'bar',
        data: {
          labels: langLabels,
          datasets: [{
            label: 'Conversations',
            data: langCounts,
            backgroundColor: cssAlpha('--amber', 0.7),
            borderWidth: 0,
            barPercentage: 0.7,
            categoryPercentage: 0.85,
          }],
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: cssVar('--surface2'), borderColor: cssVar('--border'), borderWidth: 1,
              bodyFont: { size: 12 }, padding: 10,
              callbacks: {
                label: function(c) { return `${c.parsed.x.toLocaleString()} conversations`; }
              },
            },
          },
          scales: {
            x: { beginAtZero: true, grid: { color: cssVar('--surface2') }, ticks: { precision: 0 } },
            y: { grid: { display: false }, ticks: { font: { family: "'JetBrains Mono', monospace", size: 11 } } },
          },
        },
      });
    } else {
      const statLine = document.getElementById('code-stat-line');
      if (statLine) statLine.textContent = 'No code blocks detected in conversations.';
    }
  }

  /** Build the activity-by-year overview table. */
  function buildActivityTable() {
    const activityData = D.activity_by_year;
    if (!activityData || !activityData.length) return;
    const actEl = document.getElementById('activity-table');
    const tbl = document.createElement('table');
    const th = document.createElement('thead');
    const hr = document.createElement('tr');
    ['Year', 'Total Days', 'Active', '% Active', 'Inactive', '% Inactive'].forEach(function(h) {
      const cell = txt('th', h);
      if (h !== 'Year') cell.className = 'num-col';
      hr.appendChild(cell);
    });
    th.appendChild(hr);
    tbl.appendChild(th);

    const tb = document.createElement('tbody');
    activityData.forEach(function(row) {
      const tr = document.createElement('tr');
      const isOverall = row.year === 'Overall';
      if (isOverall) tr.style.fontWeight = '700';
      const yearTd = txt('td', row.year);
      if (isOverall) yearTd.style.color = 'var(--amber)';
      tr.appendChild(yearTd);
      tr.appendChild(txt('td', row.total_days.toLocaleString(), 'num'));
      tr.appendChild(txt('td', row.days_active.toLocaleString(), 'num'));
      tr.appendChild(txt('td', `${row.pct_active.toFixed(1)}%`, 'num'));
      tr.appendChild(txt('td', row.days_inactive.toLocaleString(), 'num'));
      tr.appendChild(txt('td', `${row.pct_inactive.toFixed(1)}%`, 'num'));
      tb.appendChild(tr);
    });
    tbl.appendChild(tb);
    actEl.appendChild(tbl);
  }

  /** Filter gaps by start year. @param {Object[]} gaps @param {string[]} years @returns {Object[]} */
  function filterGapsByYear(gaps, years) {
    if (years.indexOf('All') >= 0 || years.length === 0) return gaps;
    return gaps.filter(function(g) {
      return years.indexOf(g.start_timestamp.substring(0, 4)) >= 0;
    });
  }

  /** Re-render gap rows. @param {HTMLElement} tbody @param {Object[]} gaps @param {string[]} years @param {number} limit */
  function renderGapTableRows(tbody, gaps, years, limit) {
    clearChildren(tbody);
    filterGapsByYear(gaps, years).slice(0, limit).forEach(function(g, i) {
      const tr = document.createElement('tr');
      tr.appendChild(txt('td', String(i + 1), 'rank'));
      tr.appendChild(txt('td', formatDate(g.start_timestamp), 'date'));
      tr.appendChild(txt('td', formatDate(g.end_timestamp)));
      tr.appendChild(txt('td', g.length_days.toFixed(1), 'num'));
      tbody.appendChild(tr);
    });
  }

  /** Build multi-select year pill bar. @param {HTMLElement} container @param {string[]} years @param {function} onFilterChange */
  function buildGapPillBar(container, years, onFilterChange) {
    const pillBar = el('div', { className: 'pill-bar' });
    let allGapPill = null;
    function getSelected() {
      const selected = [];
      pillBar.querySelectorAll('.pill').forEach(function(p) {
        if (p.classList.contains('active') && p.textContent !== 'All') selected.push(p.textContent);
      });
      return selected;
    }
    function syncAllPill() {
      const yearPills = pillBar.querySelectorAll('.pill:not([data-all])');
      let allActive = true;
      yearPills.forEach(function(p) { if (!p.classList.contains('active')) allActive = false; });
      if (allActive || getSelected().length === 0) {
        allGapPill.classList.add('active');
        yearPills.forEach(function(p) { p.classList.add('active'); });
      } else {
        allGapPill.classList.remove('active');
      }
    }
    years.forEach(function(yr) {
      const pill = txt('button', yr, 'pill active');
      pill.type = 'button';
      if (yr === 'All') {
        pill.setAttribute('data-all', 'true');
        allGapPill = pill;
        pill.addEventListener('click', function() {
          pillBar.querySelectorAll('.pill').forEach(function(p) { p.classList.add('active'); });
          onFilterChange(['All']);
        });
      } else {
        pill.addEventListener('click', function() {
          pill.classList.toggle('active');
          const selected = getSelected();
          if (selected.length === 0) {
            allGapPill.classList.add('active');
            pillBar.querySelectorAll('.pill:not([data-all])').forEach(function(p) { p.classList.add('active'); });
            onFilterChange(['All']);
          } else {
            syncAllPill();
            onFilterChange(selected);
          }
        });
      }
      pillBar.appendChild(pill);
    });
    container.appendChild(pillBar);
  }

  /** Build the gap analysis table with year-filter pills. */
  function buildGapTable() {
    if (!D.gaps || !D.gaps.length) return;
    const gs = D.gap_stats || {};
    const gapsEl = document.getElementById('gaps-table');
    const TOP_GAPS_LIMIT = 20;
    let selectedYears = ['All'];
    // Title
    const titleEl = txt('h3', 'Longest Gaps');
    if (gs.proportion_inactive) {
      const pctSpan = document.createElement('span');
      pctSpan.textContent = ` (${gs.proportion_inactive.toFixed(1)}% of days inactive)`;
      pctSpan.style.fontWeight = '400';
      pctSpan.style.color = 'var(--text-dim)';
      pctSpan.style.fontSize = '12px';
      titleEl.appendChild(pctSpan);
    }
    gapsEl.appendChild(titleEl);
    // Year pills
    const gapYearSet = {};
    D.gaps.forEach(function(g) { gapYearSet[g.start_timestamp.substring(0, 4)] = true; });
    const gapYears = ['All'];
    Object.keys(gapYearSet).sort().forEach(function(y) { gapYears.push(y); });
    // Table structure
    const table = document.createElement('table');
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    headerRow.appendChild(txt('th', '#'));
    headerRow.appendChild(txt('th', 'Start'));
    headerRow.appendChild(txt('th', 'End'));
    headerRow.appendChild(txt('th', 'Days', 'num-col'));
    thead.appendChild(headerRow);
    table.appendChild(thead);
    const gapTbody = document.createElement('tbody');
    table.appendChild(gapTbody);
    // Pill bar with callback
    buildGapPillBar(gapsEl, gapYears, function(years) {
      selectedYears = years;
      renderGapTableRows(gapTbody, D.gaps, selectedYears, TOP_GAPS_LIMIT);
    });
    gapsEl.appendChild(table);
    renderGapTableRows(gapTbody, D.gaps, selectedYears, TOP_GAPS_LIMIT);
  }

  // ── Initialise all sections ──
  buildHeatmap();
  applyChartDefaults();
  buildHourlyChart();
  buildWeekdayCards();
  buildCodeLanguagesChart();
  buildActivityTable();
  buildGapTable();
})();
</script>
{% endblock %}
