{% extends "base.html" %}
{% block title %}Overview — ChatGPT Statistics{% endblock %}

{% block content %}
<!-- Summary Cards -->
<div class="cards" id="cards"></div>

<!-- Month-over-Month Comparison -->
<section class="chart-section fade-in">
  <h2>Comparison</h2>
  <div class="comparison-grid" id="comparison-grid"></div>
</section>

<!-- Monthly Usage Chart -->
<section class="chart-section fade-in">
  <h2>Monthly Usage</h2>
  <div class="chart-box">
    <h3>Chats per Month</h3>
    <canvas id="chart-monthly"></canvas>
  </div>
</section>

<!-- Conversation Length Distribution -->
<section class="chart-section fade-in">
  <h2>Conversation Depth</h2>
  <div class="chart-box">
    <h3>Messages per Conversation</h3>
    <canvas id="chart-length"></canvas>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
(function() {
  const D = DASHBOARD_DATA;
  if (!D.summary) return;

  // ── Summary Cards ────────────────────────
  const s = D.summary;
  const gs = D.gap_stats || {};
  const longestGap = gs.longest_gap ? gs.longest_gap.length_days.toFixed(1) + 'd' : '\u2014';
  const cardsData = [
    { label: 'Total Chats', value: s.total_chats.toLocaleString(), accent: true },
    { label: 'Total Messages', value: s.total_messages.toLocaleString(), accent: true },
    { label: 'Date Range', value: s.first_date ? s.first_date + ' \u2192 ' + s.last_date : '\u2014', small: true },
    { label: 'Time Span', value: s.years_span ? s.years_span.toFixed(1) + ' yrs' : '\u2014' },
    { label: 'Days Active', value: gs.days_active ? gs.days_active.toLocaleString() : '\u2014', sub: gs.total_days ? 'of ' + gs.total_days.toLocaleString() + ' total' : '' },
    { label: 'Longest Gap', value: longestGap },
  ];

  // Content analytics cards
  const cs = D.content_summary || {};
  if (cs.avg_user_words != null) {
    cardsData.push({ label: 'Avg Your Message', value: cs.avg_user_words.toLocaleString() + ' words' });
    cardsData.push({ label: 'Avg ChatGPT Reply', value: cs.avg_asst_words.toLocaleString() + ' words' });
    cardsData.push({ label: 'Response Ratio', value: cs.avg_response_ratio + 'x', sub: 'ChatGPT words per your word' });
    cardsData.push({ label: 'Code in Conversations', value: cs.pct_conversations_with_code + '%' });
  }

  const cardsEl = document.getElementById('cards');
  cardsData.forEach(function(c) {
    let valCls = 'value';
    if (c.accent) valCls += ' accent';
    if (c.small) valCls += ' small';
    const children = [
      txt('div', c.label, 'label'),
      txt('div', c.value, valCls),
    ];
    if (c.sub) children.push(txt('div', c.sub, 'sub'));
    cardsEl.appendChild(el('div', { className: 'card fade-in' }, children));
  });

  applyChartDefaults();

  // ── Comparison Cards ─────────────────────
  const comp = D.comparison;
  if (comp) {
    const grid = document.getElementById('comparison-grid');

    // Computes a percentage change label and CSS class between two values.
    // newVal: current (new) value
    // oldVal: previous (old) value to compare against
    // returns: Object with text and cls properties for display
    function pctChange(newVal, oldVal) {
      if (oldVal === 0) return newVal > 0 ? { text: 'New', cls: 'up' } : { text: '\u2014', cls: 'neutral' };
      const pct = ((newVal - oldVal) / oldVal * 100).toFixed(0);
      if (pct > 0) return { text: '+' + pct + '%', cls: 'up' };
      if (pct < 0) return { text: pct + '%', cls: 'down' };
      return { text: '0%', cls: 'neutral' };
    }

    /**
     * Builds a comparison card DOM element for a given time period.
     * @param {string} title - Card heading (e.g. "This Month vs Last Month").
     * @param {Object} current - Stats for the current period (chats, messages, avg_messages, projected_chats, projected_messages).
     * @param {Object} previous - Stats for the previous period (chats, messages, avg_messages).
     * @param {string} [subtitle] - Optional subtitle text shown below the heading.
     * @returns {HTMLElement} The constructed comparison card element.
     */
    function buildComparisonCard(title, current, previous, subtitle) {
      const card = el('div', { className: 'comparison-card' });
      card.appendChild(txt('h3', title));
      if (subtitle) card.appendChild(txt('div', subtitle, 'comparison-subtitle'));

      const metrics = [
        { label: 'Chats', cur: current.chats, prev: previous.chats, proj: current.projected_chats },
        { label: 'Messages', cur: current.messages, prev: previous.messages, proj: current.projected_messages },
        { label: 'Avg msgs/chat', cur: current.avg_messages, prev: previous.avg_messages },
      ];

      metrics.forEach(function(m) {
        const compareVal = m.proj != null ? m.proj : m.cur;
        const change = pctChange(compareVal, m.prev);
        const row = el('div', { className: 'comparison-row' });
        row.appendChild(txt('span', m.label, 'comparison-label'));
        const vals = el('div', { className: 'comparison-values' });
        vals.appendChild(txt('span', m.prev.toLocaleString(), 'comparison-old'));
        vals.appendChild(txt('span', '\u2192'));
        vals.appendChild(txt('span', m.cur.toLocaleString(), 'comparison-new'));
        if (m.proj != null) {
          vals.appendChild(txt('span', '(\u2248' + Math.round(m.proj).toLocaleString() + ')', 'comparison-proj'));
        }
        vals.appendChild(txt('span', change.text, 'comparison-change ' + change.cls));
        row.appendChild(vals);
        card.appendChild(row);
      });

      return card;
    }

    const tmSub = comp.this_month.elapsed_days + ' of ' + comp.this_month.total_days + ' days';
    const tySub = comp.this_year.elapsed_days + ' of ' + comp.this_year.total_days + ' days';

    grid.appendChild(buildComparisonCard(
      'This Month vs Last Month', comp.this_month, comp.last_month, tmSub
    ));
    grid.appendChild(buildComparisonCard(
      'This Year vs Last Year', comp.this_year, comp.last_year, tySub
    ));
  }

  // ── Monthly Usage Chart ──────────────────
  const monthly = D.monthly;
  if (monthly && monthly.months && monthly.months.length) {
    const ctx = document.getElementById('chart-monthly').getContext('2d');
    const labels = monthly.months.map(function(m) { return m + '-01T00:00:00'; });

    new Chart(ctx, {
      data: {
        labels: labels,
        datasets: [
          {
            type: 'bar',
            label: 'Chats',
            data: monthly.chats,
            backgroundColor: 'rgba(108,180,217,0.5)',
            borderWidth: 0,
            barPercentage: 0.8,
            categoryPercentage: 0.9,
            order: 2,
          },
          {
            type: 'line',
            label: '3-month avg',
            data: monthly.chats_avg_3m,
            borderColor: '#e06c6c',
            borderWidth: 2,
            pointRadius: 0,
            pointHoverRadius: 3,
            tension: 0.3,
            order: 1,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: {
            position: 'top',
            labels: { usePointStyle: true, pointStyle: 'circle', padding: 16, font: { size: 11 } },
          },
          tooltip: {
            backgroundColor: '#1e2029', borderColor: '#2a2d3a', borderWidth: 1,
            titleFont: { family: "'JetBrains Mono', monospace", size: 11 },
            bodyFont: { size: 12 }, padding: 10,
          },
        },
        scales: {
          x: {
            type: 'time',
            time: { unit: 'month', displayFormats: { month: 'MMM yyyy' } },
            grid: { display: false },
            ticks: { maxRotation: 0, autoSkip: true, maxTicksLimit: 12 },
          },
          y: { beginAtZero: true, grid: { color: '#1e2029' }, ticks: { precision: 0 } },
        },
      },
    });
  }

  // ── Length Distribution Histogram ─────────
  const dist = D.length_distribution;
  if (dist && dist.buckets && dist.buckets.length) {
    const ctx2 = document.getElementById('chart-length').getContext('2d');

    new Chart(ctx2, {
      type: 'bar',
      data: {
        labels: dist.buckets,
        datasets: [{
          label: 'Conversations',
          data: dist.counts,
          backgroundColor: [
            'rgba(108,180,217,0.7)',
            'rgba(92,184,112,0.7)',
            'rgba(229,165,75,0.7)',
            'rgba(224,138,122,0.7)',
            'rgba(160,124,224,0.7)',
            'rgba(224,108,108,0.7)',
          ],
          borderWidth: 0,
          barPercentage: 0.7,
        }],
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: '#1e2029', borderColor: '#2a2d3a', borderWidth: 1,
            bodyFont: { size: 12 }, padding: 10,
            callbacks: {
              label: function(tipCtx) { return tipCtx.parsed.x.toLocaleString() + ' conversations'; }
            },
          },
        },
        scales: {
          x: { beginAtZero: true, grid: { color: '#1e2029' }, ticks: { precision: 0 } },
          y: { grid: { display: false } },
        },
      },
    });
  }

})();
</script>
{% endblock %}
